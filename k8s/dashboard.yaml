apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard
  namespace: vmservice
  labels:
    grafana_dashboard: "1"
data:
  vmservice.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "title": "Active Connections",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "targets": [{"expr": "nginx_connections_active{namespace=\"vmservice\"}", "legendFormat": "active", "refId": "A"}],
          "fieldConfig": {"defaults": {"unit": "short"}}
        },
        {
          "title": "Connections Rate",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "targets": [
            {"expr": "rate(nginx_connections_accepted{namespace=\"vmservice\"}[1m])", "legendFormat": "accepted/s", "refId": "A"},
            {"expr": "rate(nginx_connections_handled{namespace=\"vmservice\"}[1m])", "legendFormat": "handled/s", "refId": "B"}
          ],
          "fieldConfig": {"defaults": {"unit": "reqps"}}
        },
        {
          "title": "HTTP Requests Rate",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "targets": [{"expr": "rate(nginx_http_requests_total{namespace=\"vmservice\"}[1m])", "legendFormat": "requests/s", "refId": "A"}],
          "fieldConfig": {"defaults": {"unit": "reqps"}}
        },
        {
          "title": "Connection States",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "targets": [
            {"expr": "nginx_connections_reading{namespace=\"vmservice\"}", "legendFormat": "reading", "refId": "A"},
            {"expr": "nginx_connections_writing{namespace=\"vmservice\"}", "legendFormat": "writing", "refId": "B"},
            {"expr": "nginx_connections_waiting{namespace=\"vmservice\"}", "legendFormat": "waiting", "refId": "C"}
          ],
          "fieldConfig": {"defaults": {"unit": "short"}}
        },
        {
          "title": "Total Requests",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 16},
          "targets": [{"expr": "nginx_http_requests_total{namespace=\"vmservice\"}", "refId": "A"}]
        },
        {
          "title": "Total Connections Accepted",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 16},
          "targets": [{"expr": "nginx_connections_accepted{namespace=\"vmservice\"}", "refId": "A"}]
        },
        {
          "title": "Total Connections Handled",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 16},
          "targets": [{"expr": "nginx_connections_handled{namespace=\"vmservice\"}", "refId": "A"}]
        },
        {
          "title": "Nginx Up",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 16},
          "targets": [{"expr": "nginx_up{namespace=\"vmservice\"}", "refId": "A"}],
          "fieldConfig": {"defaults": {"mappings": [{"type": "value", "options": {"1": {"text": "UP", "color": "green"}, "0": {"text": "DOWN", "color": "red"}}}]}}
        }
      ],
      "refresh": "5s",
      "schemaVersion": 39,
      "tags": ["vmservice", "nginx"],
      "templating": {"list": []},
      "time": {"from": "now-15m", "to": "now"},
      "title": "VM Auto Service - Nginx Metrics",
      "uid": "vmservice-nginx",
      "version": 1
    }
